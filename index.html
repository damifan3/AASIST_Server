<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AASIST 语音伪造检测</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
        }
        .container {
            background: #ffffff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        h1 {
            color: #1a1a1a;
            margin-bottom: 1.5rem;
        }
        input[type="file"] {
            display: none;
        }
        .upload-label {
            display: inline-block;
            padding: 12px 25px;
            background-color: #007aff;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .upload-label:hover {
            background-color: #005bb5;
        }
        button {
            /* 使用 Vue 控制显示/隐藏，不在 CSS 中硬编码 display */
            padding: 12px 25px;
            background-color: #34c759;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-top: 1rem;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #2ca048;
        }
        #file-name {
            margin-top: 1rem;
            font-style: italic;
            color: #555;
        }
        #result-container {
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        #result-label {
            font-size: 1.8rem;
            font-weight: 600;
        }
        .bonafide { color: #34c759; }
        .spoof { color: #ff3b30; }
        #result-score {
            font-size: 1rem;
            color: #666;
            margin-top: 0.5rem;
        }
        .spinner {
            border: 4px solid rgba(0,0,0,.1);
            border-left-color: #007aff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 1.5rem auto 0 auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="app">
    <div class="container">
        <h1>中文语音克隆检测</h1>
        
        <!-- 点击 label 会触发隐藏的 input 选择文件 -->
        <label for="audio-file" class="upload-label">
            选择 .wav 音频文件
        </label>
        <!-- 使用 Vue 的 @change 事件绑定来处理文件选择 -->
        <input type="file" id="audio-file" accept=".wav,audio/wav" @change="onFileChange">
        
        <!-- 使用双花括号显示响应式文件名 -->
        <div id="file-name">{{ fileName }}</div>

        <!-- 按钮显示由 Vue 控制：当有文件时显示，同时在加载时禁用 -->
        <button id="predict-button" @click="uploadAndPredict" :disabled="loading" v-show="selectedFile">
            <!-- 按钮文本在加载时改变，给用户反馈 -->
            <span v-if="!loading">开始检测</span>
            <span v-else>检测中...</span>
        </button>

        <!-- 加载动画由 Vue 控制显示 -->
        <div class="spinner" v-show="loading"></div>

        <!-- 检测结果区域由 Vue 控制显示 -->
        <div id="result-container" v-if="resultVisible">
            <h3>检测结果</h3>
            <!-- 根据结果的 is_bonafide 字段选择样式 -->
            <div id="result-label" :class="result.is_bonafide ? 'bonafide' : 'spoof'">{{ result.result_label }}</div>
            <div id="result-score">(真实分数: {{ result.bonafide_score.toFixed(4) }})</div>
        </div>
    </div>
    </div>
    </div>

    <!--
        下面使用 Vue 3 (通过 CDN) 将页面改写为响应式应用。
        说明：为了保持简单，这里使用全局构建 (global build) 的 Vue，适合直接在单个 HTML 文件中开发和演示。
        如果需要更复杂的工程化（例如单文件组件、模块打包），可以改用 Vite + 单文件组件 (.vue)。
    -->
    <!-- 引入 Vue 3 的全局构建 (生产版)。开发时可改为 vue.global.js（非 prod）。 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <script>
        /*
         Vue 3 应用说明（中文注释说明每一部分的用途）：

         - createApp(): 创建 Vue 应用实例并挂载到 DOM 节点 `#app`。
         - reactive / ref: 用于创建响应式状态；当状态改变时，绑定到模板的视图会自动更新。
         - methods: 定义可在模板中调用的函数（例如文件选择与上传逻辑）。
         - v-model / v-if / v-on: 模板指令用于绑定数据、条件渲染与事件绑定。

         下面的实现把原有的 DOM 操作（getElementById、手动显示/隐藏）全部改为 Vue 的响应式状态控制，
         让代码更易维护和扩展，同时保留与后端 `/predict/` 的交互逻辑（fetch 上传 FormData）。
        */

        const { createApp, ref } = Vue;

        createApp({
            setup() {
                // 选中文件的引用（File 对象）
                const selectedFile = ref(null);

                // 用于显示的文件名，用户友好提示
                const fileName = ref('未选择文件');

                // 是否正在加载（用于显示 spinner）
                const loading = ref(false);

                // 是否显示检测结果区域
                const resultVisible = ref(false);

                // 检测结果结构：{ is_bonafide: boolean, bonafide_score: number, result_label: string }
                const result = ref({ is_bonafide: false, bonafide_score: 0, result_label: '' });

                // 文件选择处理函数（由 <input type="file"> 的 change 事件触发）
                function onFileChange(event) {
                    const files = event.target.files;
                    if (files && files.length > 0) {
                        selectedFile.value = files[0];
                        fileName.value = files[0].name;
                        // 重置上一次的结果
                        resultVisible.value = false;
                    } else {
                        selectedFile.value = null;
                        fileName.value = '未选择文件';
                    }
                }

                // 上传并请求后端预测的异步函数
                async function uploadAndPredict() {
                    if (!selectedFile.value) {
                        // 在 Vue 中你也可以用更优雅的 UI 提示，这里沿用简单 alert
                        alert('请先选择一个文件。');
                        return;
                    }

                    // 创建 FormData 并附加文件，后端 Flask / FastAPI 等能接收
                    const formData = new FormData();
                    formData.append('file', selectedFile.value);

                    // 设置加载中状态，模板会显示 spinner，并禁用按钮
                    loading.value = true;
                    resultVisible.value = false;

                    try {
                        const response = await fetch('/predict/', {
                            method: 'POST',
                            body: formData,
                        });

                        if (!response.ok) {
                            // 尝试解析后端返回的错误信息
                            let msg = `HTTP 错误: ${response.status}`;
                            try {
                                const err = await response.json();
                                msg = err.detail || JSON.stringify(err);
                            } catch (e) {
                                // 无法 JSON 解析则保持原消息
                            }
                            throw new Error(msg);
                        }

                        const data = await response.json();

                        // 将后端返回的数据写入 result 并显示
                        result.value = data;
                        resultVisible.value = true;

                    } catch (err) {
                        // 出错时显示一个错误结果（将错误信息放在 result_label 中）
                        result.value = { is_bonafide: false, bonafide_score: 0, result_label: '检测失败：' + err.message };
                        resultVisible.value = true;
                        console.error('预测出错：', err);
                    } finally {
                        // 无论成功或失败都要取消加载状态
                        loading.value = false;
                    }
                }

                // 导出到模板中使用的数据和方法
                return {
                    selectedFile,
                    fileName,
                    loading,
                    resultVisible,
                    result,
                    onFileChange,
                    uploadAndPredict,
                };
            }
        }).mount('#app');
    </script>

</body>
</html>